<!DOCTYPE html>
<html>
<head>
<link rel=stylesheet type="text/css" href="/house.css" title="House">
<script>

var DccLastStatus = 0;

function newAction (vehicle, text, command, state) {
    var button = document.createElement("button");
    button.innerHTML = text;
    button.type = 'button';
    button.disabled = false;
    button.resourceId = vehicle;
    button.resourceState = state;
    button.onclick = command;
    return button;
}

function newOnOff (vehicle, text, command, state) {
    var button = newAction (vehicle, text, command, state);
    button.resourceDevice = text;
    if (state) {
        button.style.backgroundColor = 'rgb(199,255,51)';
        button.style.color = 'black';
    }
    return button;
}

function dccSetDevice () {
    var requested = this.resourceState?'off':'on';
    var command = new XMLHttpRequest();
    var url = "/dcc/fleet/set?id="+this.resourceId + "&device=" + this.resourceDevice + "&state=" + requested;
    command.open("GET", url);
    command.onreadystatechange = function () {
        if (command.readyState === 4 && command.status === 200) {
            dccShowStatus (JSON.parse(command.responseText));
        }
    }
    command.send(null);
}

function dccSetSpeed (id, speed) {

    if ((speed < -28) || (speed > 28)) return;

    var command = new XMLHttpRequest();
    var url = "/dcc/fleet/move?id="+ id + "&speed=" + speed;
    command.open("GET", url);
    command.onreadystatechange = function () {
        if (command.readyState === 4 && command.status === 200) {
            dccShowStatus (JSON.parse(command.responseText));
        }
    }
    command.send(null);
}

function dccIncreaseSpeed () {
    dccSetSpeed (this.resourceId, this.resourceState + 1);
}

function dccDecreaseSpeed () {
    dccSetSpeed (this.resourceId, this.resourceState - 1);
}

function dccStop () {

    var command = new XMLHttpRequest();
    var url = "/dcc/fleet/stop?id="+ this.resourceId + "&urgent=1";
    command.open("GET", url);
    command.onreadystatechange = function () {
        if (command.readyState === 4 && command.status === 200) {
            dccShowStatus (JSON.parse(command.responseText));
        }
    }
    command.send(null);
}

function dccSortVehicle (a, b) {
    return a.address > b.address;
}

function dccShowVehicles (response) {

   var table = document.getElementById ('vehicles');
   var remove = document.getElementsByClassName ('removeThisLine');
   while (remove.length > 0) {
       table.removeChild(remove[0]);
   }
   if (!response.trains.vehicles) return;

   var vehicles = response.trains.vehicles.sort (dccSortVehicle);
   for (var i = 0; i < vehicles.length; i++) {

        var vehicle = vehicles[i];

        var row = document.createElement("tr");
        row.className = "removeThisLine";

        var column = document.createElement("td");
        column.innerHTML = vehicle.id;
        row.appendChild(column);

        column = document.createElement("td");
        column.innerHTML = '' + vehicle.address;
        row.appendChild(column);

        column = document.createElement("td");
        column.innerHTML = vehicle.model?vehicle.model:'';
        row.appendChild(column);

        column = document.createElement("td");
        column.innerHTML = vehicle.type?vehicle.type:'';
        row.appendChild(column);

        column = document.createElement("td");
        if (vehicle.type == 'engine') {
           var speed = vehicle.speed?vehicle.speed:0; // It might be missing.
           if (speed < 0) column.innerHTML = 'reverse';
           else if (speed > 0) column.innerHTML = 'forward';
           else column.innerHTML = 'stopped';
        } else {
           column.innerHTML = '';
        }
        row.appendChild(column);

        column = document.createElement("td");
        if (vehicle.type == 'engine') {
            var speed = vehicle.speed?Math.abs(vehicle.speed):0;
            if (speed > 0) column.innerHTML = ''+speed;
            else column.innerHTML = '';
        } else {
           column.innerHTML = '';
        }
        row.appendChild(column);

        column = document.createElement("td");
        if (vehicle.devices) {
           const entries = Object.entries(vehicle.devices);
           for (var j = 0; j < entries.length; ++j) {
              column.appendChild (newOnOff (vehicle.id,
                                            entries[j][0],
                                            dccSetDevice,
                                            entries[j][1]));
           }
        }
        row.appendChild(column);

        if (vehicle.type == 'engine') {
            column = document.createElement("td");
            column.appendChild (newAction (vehicle.id, '&#x25C0',
                                           dccDecreaseSpeed, vehicle.speed));
            column.appendChild (newAction (vehicle.id, "STOP", dccStop, 0));
            column.appendChild (newAction (vehicle.id, '&#x25B6',
                                           dccIncreaseSpeed, vehicle.speed));
            row.appendChild(column);
        }

        table.appendChild(row);
    }
}

function dccShowTrains (response) {
    // TBD
}

function dccShowStatus (response) {
   dccShowVehicles (response);
   dccShowTrains (response);
   DccLastStatus = response.trains.latest;
}

function dccStatus () {
    var command = new XMLHttpRequest();
    var url = "/dcc/fleet/status";
    if (DccLastStatus) url += "?known=" + DccLastStatus;
    command.open("GET", url);
    command.onreadystatechange = function () {
        if (command.readyState === 4 && command.status === 200) {
            dccShowStatus (JSON.parse(command.responseText));
        }
    }
    command.send(null);
}

window.onload = function() {
   dccStatus();
   setInterval (dccStatus, 1000);
};
</script>
<head>
   <title>Train Dashboard</title>
</head>
<body>
   <table class="housetopcontainer">
   <tr><td>
   <table class="housetop">
   <tr>
   <td><span>Dashboard</span></td>
   <td><a href="/dcc/events.html">Events</a></td>
   <td><a href="/dcc/config.html">Config</a></td>
   <td><a href="/dcc/capture.html">Capture</a></td>
   </tr>
   </table>
   </td></tr>
   </table>
   <h1>Locomotives</h1>
   <table id="vehicles" class="housewidetable" border="0">
      <tr>
         <th width="10%">ID</th>
         <th width="5%">ADDRESS</th>
         <th width="10%">MODEL</th>
         <th width="10%">TYPE</th>
         <th width="10%">DIRECTION</th>
         <th width="5%">SPEED</th>
         <th width="30%">DEVICES</th>
         <th width="20%">COMMANDS</th>
      </tr>
   </table>
   <h1>Train Consists</h1>
   <table id="trains" class="housewidetable" border="0">
      <tr>
         <th width="10%">ID</th>
         <th width="5%">ADDRESS</th>
         <th width="10%">DIRECTION</th>
         <th width="5%">SPEED</th>
         <th width="60%">VEHICLES</th>
      </tr>
   </table>
</body>
</html>

